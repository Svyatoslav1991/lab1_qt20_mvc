name: ci-windows-mingw

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # install-qt-action использует python/aqt внутри, поэтому оставляем явный python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Qt 5.14.2 (MinGW 7.3) + MinGW toolchain
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.14.2"
          # ВАЖНО: dir НЕ должен заканчиваться на \Qt, потому что action сам создаёт подкаталог Qt
          dir: "${{ github.workspace }}"
          # Этот arch соответствует твоим ранним логам (папка mingw73_64).
          # Если вдруг снова упрётся в aqt/qt_base, тогда надо будет сверить arch через aqt list-qt.
          arch: "win64_mingw73"
          tools: "tools_mingw,qt.tools.win64_mingw730"
          cache: true
          # Пусть action сам добавит Qt и tools в PATH
          add-tools-to-path: true

      - name: Diagnostics (Qt/MinGW paths)
        shell: pwsh
        run: |
          Write-Host "QT_ROOT_DIR=$env:QT_ROOT_DIR"
          Write-Host "IQTA_TOOLS=$env:IQTA_TOOLS"
          where qmake
          where mingw32-make
          where g++
          qmake --version
          g++ --version
          mingw32-make --version

      - name: Configure (CMake + MinGW Makefiles)
        shell: pwsh
        run: |
          cmake -S . -B build `
            -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DBUILD_TESTING=ON `
            -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"

      - name: Build
        shell: pwsh
        run: |
          cmake --build build --config Release -- -j 2

      - name: Test (CTest)
        shell: pwsh
        run: |
          ctest --test-dir build --output-on-failure

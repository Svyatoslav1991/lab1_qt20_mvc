name: ci-windows-mingw

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (needed by install-qt-action / aqt)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Qt (MinGW 7.3 build)
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.14.2"
          arch: "win64_mingw73"
          # ставим MinGW 7.3 toolchain (Qt Tools) — см. aqt docs
          tools: "tools_mingw,qt.tools.win64_mingw730"
          cache: true

      - name: Add Qt MinGW to PATH
        shell: pwsh
        run: |
          Write-Host "QT_ROOT_DIR=$env:QT_ROOT_DIR"
          if (!(Test-Path "$env:QT_ROOT_DIR\Tools")) {
            throw "Qt Tools folder not found: $env:QT_ROOT_DIR\Tools"
          }
          Get-ChildItem "$env:QT_ROOT_DIR\Tools" -Directory | Select-Object Name

          $mingwBin = Join-Path $env:QT_ROOT_DIR "Tools\mingw730_64\bin"
          if (!(Test-Path $mingwBin)) {
            throw "MinGW bin not found: $mingwBin"
          }
          Add-Content $env:GITHUB_PATH $mingwBin

      - name: Configure (CMake + MinGW Makefiles)
        shell: pwsh
        run: |
          cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build
        shell: pwsh
        run: |
          cmake --build build -- -j 2

      - name: Test (CTest)
        shell: pwsh
        run: |
          ctest --test-dir build --output-on-failure
